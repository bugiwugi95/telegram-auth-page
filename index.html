<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§—É—Ç–±–æ–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫ | Mini App</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* –ë–∞–∑–æ–≤—ã–µ –°—Ç–∏–ª–∏ (–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞—à–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏) */
        /* ========================================================================= */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f0f4f7);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #0088cc);
            --tg-hint: var(--tg-theme-hint-color, #888888);
            
            /* –ù–∞—à–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∑–∞–π–Ω–∞ */
            --background: var(--tg-secondary-bg);
            --foreground: var(--tg-text);
            --blue-600: #2563eb;
            --blue-100: #dbeafe;
            --blue-900: #1e3a8a;
            --blue-50: #eff6ff;
            --slate-600: #475569;
            --green-600: #16a34a;
            --red-600: #dc2626;
            --red-100: #fee2e2;
            --border: rgba(0, 0, 0, 0.1);
            --font-weight-medium: 500;
            --radius: 0.625rem;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: 'Roboto', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI";
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--tg-bg);
            color: var(--foreground);
            padding: 0;
            padding-bottom: 4.5rem; /* –ú–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        }
        .container {
            background-color: var(--tg-secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        h1 { font-size: 1.5rem; font-weight: var(--font-weight-medium); line-height: 1.5; margin: 0; }
        h2 { font-size: 1.25rem; font-weight: var(--font-weight-medium); line-height: 1.5; margin: 0; }

        /* –°—Ç–∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) */
        #auth-screen .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: bold; }
        #auth-screen .error { background-color: #ffe0e0; color: #cc0000; }
        #auth-screen .success { background-color: #e0ffe0; color: #008000; }
        #auth-screen .loading { background-color: #e0f0ff; color: #0066cc; }
        #auth-screen .debug-info { background: var(--tg-bg); border: 1px solid var(--border); border-radius: 5px; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 0.8em; text-align: left; max-height: 200px; overflow-y: auto; }
        #auth-screen .retry-button { background-color: var(--tg-link); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }

        /* ========================================================================= */
        /* –°—Ç–∏–ª–∏ –§—É—Ç–±–æ–ª—å–Ω–æ–≥–æ –î–∞—à–±–æ—Ä–¥–∞ (–ù–æ–≤—ã–µ) */
        /* ========================================================================= */
        .app-content { width: 100%; max-width: 450px; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .pb-8 { padding-bottom: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-3 { gap: 0.75rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .w-full { width: 100%; }

        /* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
        .header-bg { background-color: var(--blue-600); color: var(--background); }
        .text-blue-100 { color: var(--blue-100); }
        .text-blue-900 { color: var(--blue-900); }
        .text-slate-600 { color: var(--slate-600); }
        .card { background-color: var(--background); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
        .stat-icon-blue { background-color: var(--blue-100); color: var(--blue-600); }
        .stat-icon-red { background-color: var(--red-100); color: var(--red-600); }
        .rounded-full { border-radius: 9999px; }
        .h-10 { height: 2.5rem; }
        
        .last-match-card { background-color: var(--blue-50); border-color: var(--blue-100); border-width: 2px; }
        .last-match-badge { background-color: var(--green-600); color: var(--background); }
        .last-match-button { background-color: var(--blue-600); color: var(--background); height: 3rem; text-decoration: none; display: flex; align-items: center; justify-content: center; padding: 0 1rem; border-radius: var(--radius); font-weight: var(--font-weight-medium); }

        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-draw { background-color: #fef9c3; color: #a16207; }

        /* ========================================================================= */
        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ù–∏–∂–Ω—è—è –ù–∞–≤–∏–≥–∞—Ü–∏—è (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è) */
        /* ========================================================================= */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4.5rem;
            background-color: var(--background);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--slate-600);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            transition: color 0.2s;
            width: 30%;
        }
        .nav-item-active {
            color: var(--blue-600);
        }
        .nav-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .screen { display: none; width: 100%; max-width: 450px; }
        .active-screen { display: block; }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="container">
            <h1>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h1>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –í–∞—à–∞ –ª–∏—á–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è...</p>
            <div class="status loading" id="status-message">‚è≥ –ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <p style="font-size: 0.8em; opacity: 0.7;">ID: <span id="telegram-id">--</span></p>
            
            <div class="debug-info" id="debug-info" style="display: none;">
                <strong>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                <div id="debug-content"></div>
            </div>
            
            <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8em;">
                –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É
            </button>
            
            <button class="retry-button" onclick="retryAuth()" id="retry-button" style="display: none;">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>
    </div>
    
    <div id="main-app" class="app-content" style="display: none;">
        
        <div id="dashboard-screen" class="screen active-screen">
            <div class="header-bg p-6 pb-8">
                <div class="flex items-center gap-3 mb-2">
                    <span style="color: white; font-size: 1.25rem;">üè†</span>
                    <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
                </div>
                <p class="text-blue-100">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
            </div>

            <div class="p-4 -mt-4">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="card p-4" style="border-width: 2px; border-color: var(--blue-100);">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full stat-icon-blue flex items-center justify-center">
                                <span>üìà</span>
                            </div>
                        </div>
                        <div class="text-slate-600 mb-1">–í–ª–∞–¥–µ–Ω–∏–µ</div>
                        <div class="text-blue-900">58%</div>
                    </div>
                    
                    <div class="card p-4" style="border-width: 2px; border-color: var(--blue-100);">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full stat-icon-red flex items-center justify-center">
                                <span>‚ö†Ô∏è</span>
                            </div>
                        </div>
                        <div class="text-slate-600 mb-1">–ü–æ—Ç–µ—Ä–∏</div>
                        <div class="text-blue-900">23</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h2 class="text-blue-900 mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Ç—á</h2>
                    <div class="card p-4 last-match-card">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span style="color: var(--blue-600);">üìÖ</span>
                                <span class="text-slate-700">28 –æ–∫—Ç 2025</span>
                            </div>
                            <div class="badge last-match-badge">–ü–æ–±–µ–¥–∞</div>
                        </div>
                        <div class="flex items-center justify-between mb-3 text-blue-900">
                            <span>vs –§–ö –°–ø–∞—Ä—Ç–∞–∫</span>
                            <span>2:1</span>
                        </div>
                        <button onclick="navigate('analytics')" class="last-match-button w-full">
                            –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-blue-900 mb-3">–í—Å–µ –º–∞—Ç—á–∏</h2>
                    <div class="space-y-3">
                        <div class="card p-4 border border-slate-200 cursor-pointer hover:border-blue-700 transition-colors" onclick="navigate('analytics')">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-slate-600">21 –æ–∫—Ç 2025</span>
                                </div>
                                <div class="badge badge-draw">–ù–∏—á—å—è</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics-screen" class="screen">
            <div class="header-bg p-6 pb-8">
                <div class="flex items-center gap-3 mb-2">
                    <span style="color: white; font-size: 1.25rem;">üìä</span>
                    <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞—Ç—á–∞</h1>
                </div>
                <p class="text-blue-100">–§–ö –°–ø–∞—Ä—Ç–∞–∫ ‚Ä¢ 28 –æ–∫—Ç 2025</p>
            </div>
            <div class="p-4 -mt-4">
                <div class="card p-4" style="border: 2px solid var(--blue-100);">
                    <h3 class="text-blue-900 mb-2">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <p class="text-slate-600">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ –∏ –≥—Ä–∞—Ñ, –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ –≤ —Ñ–∞–π–ª–µ `match_analytics.html`.</p>
                    <p class="text-slate-600 mt-2">–ù–∞–∂–º–∏—Ç–µ "–ò–≥—Ä–æ–∫–∏", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.</p>
                </div>
            </div>
        </div>

        <div id="players-screen" class="screen">
            <div class="header-bg p-6 pb-8">
                <div class="flex items-center gap-3 mb-2">
                    <span style="color: white; font-size: 1.25rem;">üë§</span>
                    <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞</h1>
                </div>
                <p class="text-blue-100">–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
            </div>
            <div class="p-4 -mt-4">
                <div class="card p-4" style="border: 2px solid var(--blue-100);">
                    <h3 class="text-blue-900 mb-2">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</h3>
                    <p class="text-slate-600">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–≥—Ä–æ–∫–∞, –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π, –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ –≤ —Ñ–∞–π–ª–µ `player_stats.html`.</p>
                    <p class="text-slate-600 mt-2">–ù–∞–∂–º–∏—Ç–µ "–ì–ª–∞–≤–Ω–∞—è", —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è.</p>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <a href="#" onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item nav-item-active">
                <span class="nav-icon">üè†</span>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="#" onclick="navigate('analytics')" id="nav-analytics" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
            </a>
            <a href="#" onclick="navigate('players')" id="nav-players" class="nav-item">
                <span class="nav-icon">üë§</span>
                <span>–ò–≥—Ä–æ–∫–∏</span>
            </a>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let debugInfo = '';
        
        // !!! –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–í–û–ô URL –ë–≠–ö–ï–ù–î–ê –ó–î–ï–°–¨ !!!
        const backendUrl = 'https://definable-outspokenly-janyce.ngrok-free.dev/api/auth/telegram';
        // -----------------------------------------------------------------

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        function navigate(page) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-item-active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
            const screenElement = document.getElementById(`${page}-screen`);
            const navElement = document.getElementById(`nav-${page}`);
            
            if (screenElement) {
                screenElement.classList.add('active-screen');
            }
            if (navElement) {
                navElement.classList.add('nav-item-active');
            }
            
            // –ï—Å–ª–∏ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–æ–±—â–∞–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showApp(userName) {
            console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è:', userName);
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
            // document.getElementById('welcome-message').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
            
            // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –î–∞—à–±–æ—Ä–¥
            navigate('dashboard');
        }

        // –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (–û–°–¢–ê–í–õ–ï–ù–´ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
        // ----------------------------------------------------
        function cleanInitData(initData) {
            const params = initData.split('&');
            const allowedParams = params.filter(param => {
                const key = param.split('=')[0];
                return ['auth_date', 'query_id', 'user', 'hash', 'receiver', 'chat', 'chat_type', 'chat_instance', 'start_param'].includes(key);
            });
            const cleanedParams = allowedParams.filter(param => !param.startsWith('signature='));
            return cleanedParams.join('&');
        }

        function showDebugInfo(info) {
            const debugInfoElement = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugContent.textContent = info;
            debugInfoElement.style.display = 'block';
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function retryAuth() {
            document.getElementById('retry-button').style.display = 'none';
            document.getElementById('status-message').className = 'status loading';
            document.getElementById('status-message').textContent = '‚è≥ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...';
            startAuthProcess();
        }

        async function startAuthProcess() {
            const statusElement = document.getElementById('status-message');
            const idElement = document.getElementById('telegram-id');
            
            debugInfo = 'üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n';
            debugInfo += `üåê Backend URL: ${backendUrl}\n`;

            if (!window.Telegram || !window.Telegram.WebApp) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
                debugInfo += '‚ùå Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            debugInfo += '‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';

            const token = localStorage.getItem('jwt_token');
            if (token && window.Telegram.WebApp.initDataUnsafe?.user) {
                const userName = window.Telegram.WebApp.initDataUnsafe.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                debugInfo += '‚úÖ –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω\n';
                showDebugInfo(debugInfo);
                showApp(userName);
                return;
            }

            if (!window.Telegram.WebApp.initData) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                debugInfo += '‚ùå initData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            const unsafeData = window.Telegram.WebApp.initDataUnsafe;
            const user = unsafeData?.user;

            if (!user || !unsafeData.auth_date || !unsafeData.hash) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram';
                debugInfo += `‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: user=${!!user}, auth_date=${!!unsafeData.auth_date}, hash=${!!unsafeData.hash}\n`;
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            idElement.textContent = user.id;
            statusElement.textContent = `üîê –î–∞–Ω–Ω—ã–µ ${user.first_name} –ø–æ–ª—É—á–µ–Ω—ã. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥...`;

            debugInfo += `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name} (ID: ${user.id})\n`;
            debugInfo += `üì¶ –ò—Å—Ö–æ–¥–Ω—ã–π initData: ${window.Telegram.WebApp.initData.substring(0, 100)}...\n`;

            const cleanedInitData = cleanInitData(window.Telegram.WebApp.initData);
            debugInfo += `üßπ –û—á–∏—â–µ–Ω–Ω—ã–π initData: ${cleanedInitData.substring(0, 100)}...\n`;

            showDebugInfo(debugInfo);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); 

                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ initData: cleanedInitData }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();

                if (!data.token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }

                localStorage.setItem('jwt_token', data.token);
                
                statusElement.className = 'status success';
                statusElement.textContent = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
                
                debugInfo += `‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${data.token.substring(0, 20)}...\n`;
                showDebugInfo(debugInfo);

                setTimeout(() => {
                    showApp(user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                }, 1000);

            } catch (error) {
                statusElement.className = 'status error';
                
                if (error.name === 'AbortError') {
                    statusElement.textContent = '‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç';
                    debugInfo += '‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (10 —Å–µ–∫—É–Ω–¥)\n';
                } else {
                    statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    debugInfo += `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}\n`;
                }
                
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            startAuthProcess();
        });
    </script>
</body>
</html>
