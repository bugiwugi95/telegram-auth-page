<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§—É—Ç–±–æ–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫ | –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    
    <div id="token-error" class="token-error">
        <h2>‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
        <p class="text-hint">–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</p>
        <p class="text-hint">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.</p>
    </div>

    <div id="main-app" class="app-content" style="display: none;">
        
        <div id="dashboard-screen" class="screen active-screen"></div>
        <div id="analytics-screen" class="screen"></div>
        <div id="players-screen" class="screen"></div>
        <div id="stat-screen" class="screen"></div>
        <div id="admin-match-screen" class="screen"></div>


        <div class="bottom-nav">
            <a href="#" onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item nav-item-active">
                <span class="nav-icon">üè†</span>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="#" onclick="navigate('analytics')" id="nav-analytics" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
            </a>
            <a href="#" onclick="navigate('stat')" id="nav-stat" class="nav-item">
                <span class="nav-icon">üìù</span>
                <span>–í–≤–æ–¥</span>
            </a>
            <a href="#" onclick="navigate('players')" id="nav-players" class="nav-item">
                <span class="nav-icon">üë•</span>
                <span>–ò–≥—Ä–æ–∫–∏</span>
            </a>
            <a href="#" onclick="navigate('admin-match')" id="nav-admin-match" class="nav-item">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>–ê–¥–º–∏–Ω</span>
            </a>
        </div>
    </div>


    <script>
        // =========================================================================
        // –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ê–î–†–ï–°–ê
        // !!! –ê–î–†–ï–° BASE_URL –≤–∑—è—Ç –∏–∑ –≤–∞—à–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ ngrok !!!
        // =========================================================================
        const BASE_URL = 'https://definable-outspokenly-janyce.ngrok-free.dev'; 
        const STAT_SUBMIT_URL = `${BASE_URL}/api/stats/submit`; 
        const MATCH_CREATE_URL = `${BASE_URL}/api/matches`; 

        // –ú–∞–ø–ø–∏–Ω–≥ URL-–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —ç–∫—Ä–∞–Ω–æ–≤
        const screenFiles = {
            'dashboard': 'dashboard.html',
            'analytics': 'analytics.html',
            'players': 'players.html',
            'stat': 'stat-input.html',
            'admin-match': 'admin.html'
        };

        // =========================================================================
        // –ì–õ–ê–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =========================================================================

        async function loadScreenContent(page) {
            const screenElement = document.getElementById(`${page}-screen`);
            if (screenElement.innerHTML.trim() === '') {
                try {
                    const response = await fetch(screenFiles[page]);
                    if (response.ok) {
                        screenElement.innerHTML = await response.text();
                    } else {
                        screenElement.innerHTML = `<div class="p-4 card error-message">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${response.status}</div>`;
                    }
                } catch (error) {
                    screenElement.innerHTML = `<div class="p-4 card error-message">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${page}: ${error.message}</div>`;
                }
            }
        }

        async function navigate(page) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-item-active'));
            
            const screenElement = document.getElementById(`${page}-screen`);
            const navElement = document.getElementById(`nav-${page}`);
            
            if (screenElement) {
                await loadScreenContent(page);
                screenElement.classList.add('active-screen');
                window.scrollTo(0, 0); 

                // –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
                if (page === 'stat') {
                    setupStatFormHandler();
                } else if (page === 'admin-match') {
                    setupAdminFormHandler();
                }
                
                // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è Dashboard (–ø–æ–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)
                if (page === 'dashboard' || page === 'stat') {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ Telegram, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    const userName = (window.Telegram && window.Telegram.WebApp.initDataUnsafe.user)
                        ? (Telegram.WebApp.initDataUnsafe.user.username || Telegram.WebApp.initDataUnsafe.user.first_name)
                        : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
                    const welcomeUserElement = document.getElementById('welcome-user');
                    if (welcomeUserElement) {
                        welcomeUserElement.textContent = userName;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –≤–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    const statUserElement = document.getElementById('stat-user');
                    if (statUserElement) {
                        statUserElement.textContent = userName; 
                    }
                }
            }
            if (navElement) {
                navElement.classList.add('nav-item-active');
            }
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        }
        
        function initApp() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ Telegram –¥–ª—è –∑–∞–ø—É—Å–∫–∞.
            if (!window.Telegram || !window.Telegram.WebApp || !Telegram.WebApp.initData) {
                document.getElementById('token-error').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                localStorage.clear(); 
                return;
            }

            // –ü—Ä—è—á–µ–º —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('token-error').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            navigate('dashboard');
        }

        // =========================================================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–û–†–ú (–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø initData)
        // =========================================================================
        
        // 1. –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (stat-input.html)
        function setupStatFormHandler() {
            const form = document.getElementById('statForm');
            if (!form) return;

            form.removeEventListener('submit', handleStatSubmit);
            form.addEventListener('submit', handleStatSubmit);
        }

        async function handleStatSubmit(e) {
            e.preventDefault();
            const messageBox = document.getElementById('statMessage');
            messageBox.style.display = 'none';

            if (!window.Telegram.WebApp.initData) {
                messageBox.textContent = '‚ùå –û—à–∏–±–∫–∞: Telegram Web App initData –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞.';
                messageBox.className = 'message error-message';
                messageBox.style.display = 'block';
                return;
            }
            
            const initData = Telegram.WebApp.initData; 

            const payload = {
                initData: initData, // initData –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
                matchId: document.getElementById('matchIdInput').value.trim(), 
                goals: parseInt(document.getElementById('goals').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                passes: parseInt(document.getElementById('passes').value) || 0,
                errors: parseInt(document.getElementById('errors').value) || 0,
                minutesPlayed: parseInt(document.getElementById('minutesPlayed').value) || 0,
            };
            
            // ... (–ø—Ä–æ–≤–µ—Ä–∫–∏)

            try {
                const response = await fetch(STAT_SUBMIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    messageBox.textContent = '‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!';
                    messageBox.className = 'message success-message';
                    document.getElementById('statForm').reset();
                } else {
                    const errorText = await response.text();
                    messageBox.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${errorText || response.statusText}`;
                    messageBox.className = 'message error-message';
                }
            } catch (error) {
                messageBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.';
                messageBox.className = 'message error-message';
            }
            messageBox.style.display = 'block';
        }


        // 2. –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—á–∞ (admin.html)
        function setupAdminFormHandler() {
            const form = document.getElementById('createMatchForm');
            if (!form) return;
            
            form.removeEventListener('submit', handleAdminSubmit);
            form.addEventListener('submit', handleAdminSubmit);
        }

        async function handleAdminSubmit(event) {
            event.preventDefault();

            const messageDiv = document.getElementById('adminMatchMessage');
            messageDiv.textContent = '';
            messageDiv.style.display = 'none';
            
            const initData = Telegram.WebApp.initData; 
            
            if (!initData) {
                messageDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: Telegram initData –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞.';
                messageDiv.className = 'message error-message';
                messageDiv.style.display = 'block';
                return;
            }

            const matchDate = document.getElementById('matchDate').value;
            const location = document.getElementById('location').value;
            // !!! –ù–û–í–û–ï –ü–û–õ–ï !!!
            const opponentTeamName = document.getElementById('opponentTeamName').value;
            const durationMinutes = document.getElementById('durationMinutes').value;

            // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (—Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç opponentTeamName)
            const requestBody = {
                matchDate: matchDate,
                location: location,
                opponentTeamName: opponentTeamName, // –î–û–ë–ê–í–õ–ï–ù–û
                durationMinutes: durationMinutes ? parseInt(durationMinutes, 10) : null 
            };

            // !!! –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º initData, –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç MatchController.java
            const urlWithParams = `${MATCH_CREATE_URL}?initData=${encodeURIComponent(initData)}`; 

            try {
                const response = await fetch(urlWithParams, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const textResponse = await response.text();

                if (response.ok) {
                    messageDiv.textContent = `‚úÖ –£—Å–ø–µ—Ö! –ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω. ${textResponse}`;
                    messageDiv.className = 'message success-message';
                    document.getElementById('createMatchForm').reset();
                } else if (response.status === 403) {
                    messageDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ 403: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–µ—Ä–æ—è—Ç–Ω–æ, –≤—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ).`;
                    messageDiv.className = 'message error-message';
                } else {
                    messageDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${textResponse}`;
                    messageDiv.className = 'message error-message';
                }

            } catch (error) {
                messageDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ngrok –∏ BASE_URL.';
                messageDiv.className = 'message error-message';
            }
            messageDiv.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
