<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§—É—Ç–±–æ–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫ | –í—Ö–æ–¥</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* CSS –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        /* ========================================================================= */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f0f4f7);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #0088cc);
        }
        body {
            font-family: 'Roboto', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI";
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            padding: 20px;
        }
        .container {
            background-color: var(--tg-secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        h1 { color: var(--tg-link); margin-bottom: 20px; font-size: 1.5em; }
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: bold; }
        .error { background-color: #ffe0e0; color: #cc0000; }
        .success { background-color: #e0ffe0; color: #008000; }
        .loading { background-color: #e0f0ff; color: #0066cc; }
        .debug-info { 
            background: var(--tg-bg); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 5px; 
            padding: 10px; margin: 10px 0; font-family: monospace; font-size: 0.8em; 
            text-align: left; max-height: 200px; overflow-y: auto; 
        }
        .retry-button { 
            background-color: var(--tg-link); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; 
        }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="container">
            <h1>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h1>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é...</p>
            <div class="status loading" id="status-message">‚è≥ –ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <p style="font-size: 0.8em; opacity: 0.7;">ID: <span id="telegram-id">--</span></p>
            
            <div class="debug-info" id="debug-info" style="display: none;">
                <strong>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                <div id="debug-content"></div>
            </div>
            
            <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8em;">
                –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É
            </button>
            
            <button class="retry-button" onclick="retryAuth()" id="retry-button" style="display: none;">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>
    </div>

    <script>
        let debugInfo = '';
        
        // !!! –í–ê–ñ–ù–û: –ê–î–†–ï–°–ê –í–ê–®–ò–• –ë–≠–ö–ï–ù–î–û–í !!!
        // 1. –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ë–´–°–¢–†–û–ô –ü–†–û–í–ï–†–ö–ò –≤ –ë–î (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å/–Ω–µ—Ç)
        const backendCheckUrl = 'https://definable-outspokenly-janyce.ngrok-free.dev/api/check'; 
        // 2. –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ü–û–õ–ù–û–ô –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (–≤–∞—à–∞ —Å—Ç–∞—Ä–∞—è —Ä–∞–±–æ—á–∞—è –ª–æ–≥–∏–∫–∞)
        const backendAuthUrl = 'https://definable-outspokenly-janyce.ngrok-free.dev/api/auth/telegram';
        // -----------------------------------------------------------------

        function cleanInitData(initData) {
            const params = initData.split('&');
            const allowedParams = params.filter(param => {
                const key = param.split('=')[0];
                return ['auth_date', 'query_id', 'user', 'hash', 'receiver', 'chat', 'chat_type', 'chat_instance', 'start_param'].includes(key);
            });
            const cleanedParams = allowedParams.filter(param => !param.startsWith('signature='));
            return cleanedParams.join('&');
        }

        function showDebugInfo(info) {
            const debugInfoElement = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugContent.textContent = info;
            // debugInfoElement.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Ñ–∞–π–ª —Å UI
        function redirectToApp(token, userName) {
             localStorage.setItem('jwt_token', token);
             localStorage.setItem('user_name', userName);
             window.location.replace('app.html'); // !!! –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê app.html !!!
        }

        function retryAuth() {
            document.getElementById('retry-button').style.display = 'none';
            document.getElementById('status-message').className = 'status loading';
            document.getElementById('status-message').textContent = '‚è≥ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...';
            startAuthProcess();
        }

        async function startAuthProcess() {
            const statusElement = document.getElementById('status-message');
            const idElement = document.getElementById('telegram-id');
            
            debugInfo = 'üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n';
            
            if (!window.Telegram || !window.Telegram.WebApp) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
                debugInfo += '‚ùå Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            if (!window.Telegram.WebApp.initData) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                debugInfo += '‚ùå initData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            const unsafeData = window.Telegram.WebApp.initDataUnsafe;
            const user = unsafeData?.user;
            const userName = user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

            if (!user || !unsafeData.auth_date || !unsafeData.hash) {
                // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ...
                return;
            }

            idElement.textContent = user.id;
            const cleanedInitData = cleanInitData(window.Telegram.WebApp.initData);
            
            try {
                // --- 1. –ü–†–û–í–ï–†–ö–ê –í –ë–î (–ë–´–°–¢–†–´–ô –í–•–û–î) ---
                statusElement.textContent = `‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName} –≤ –ë–î...`;
                debugInfo += `1Ô∏è‚É£ –ü–æ–ø—ã—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ ${backendCheckUrl}\n`;
                showDebugInfo(debugInfo);

                let checkResponse;
                try {
                    checkResponse = await fetch(backendCheckUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: cleanedInitData })
                    });
                } catch(e) {
                     // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏/CORS, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                     debugInfo += `‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${e.message}. –ü—Ä–æ–±—É–µ–º –ø–æ–ª–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.\n`;
                }

                if (checkResponse && checkResponse.ok) {
                    const data = await checkResponse.json();
                    if (!data.token) {
                        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç 200 OK, –Ω–æ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, —ç—Ç–æ –æ—à–∏–±–∫–∞ –±—ç–∫–µ–Ω–¥–∞.
                        throw new Error('–ë–î-–ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞, –Ω–æ —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω.');
                    }
                    
                    statusElement.className = 'status success';
                    statusElement.textContent = `‚úÖ –î–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} –Ω–∞–π–¥–µ–Ω –≤ –ë–î)!`;
                    debugInfo += '‚úÖ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.\n';
                    showDebugInfo(debugInfo);
                    
                    setTimeout(() => redirectToApp(data.token, userName), 500);
                    return;
                }

                // --- 2. –ü–û–õ–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–µ—Å–ª–∏ –ë–î-–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞) ---
                
                statusElement.textContent = `üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –∏–ª–∏ –æ—à–∏–±–∫–∞. –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...`;
                debugInfo += `2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ ${backendAuthUrl}\n`;
                showDebugInfo(debugInfo);

                const authResponse = await fetch(backendAuthUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: cleanedInitData })
                });

                if (!authResponse.ok) {
                    const errorText = await authResponse.text();
                    throw new Error(`HTTP ${authResponse.status}: ${errorText.substring(0, 100)}...`);
                }

                const authData = await authResponse.json();
                
                if (!authData.token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
                statusElement.className = 'status success';
                statusElement.textContent = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
                debugInfo += `‚úÖ –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω.\n`;
                showDebugInfo(debugInfo);

                setTimeout(() => redirectToApp(authData.token, userName), 500);

            } catch (error) {
                statusElement.className = 'status error';
                statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                debugInfo += `‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: ${error.message}\n`;
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', startAuthProcess);
    </script>
</body>
</html>
</body>
</html>
