<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
   
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í–µ—Å—å CSS –≤—Å—Ç—Ä–æ–µ–Ω, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f0f4f7);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #0088cc);
            --tg-hint: var(--tg-theme-hint-color, #888888);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            padding: 20px;
        }
        .container {
            background-color: var(--tg-secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        h1 {
            color: var(--tg-link);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
        }
        .error {
            background-color: #ffe0e0;
            color: #cc0000;
        }
        .success {
            background-color: #e0ffe0;
            color: #008000;
        }
        #nav-bar button {
            background-color: var(--tg-link);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        #content-area {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--tg-bg);
            border-radius: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="container">
            <h1>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h1>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –í–∞—à–∞ –ª–∏—á–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è...</p>
            <div class="status" id="status-message">–ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <p style="font-size: 0.8em; opacity: 0.7;">ID: <span id="telegram-id">--</span></p>
        </div>
    </div>
    <div id="main-app" class="container" style="display: none;">
        <h1 id="welcome-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
       
        <div id="nav-bar">
            <button onclick="navigate('dashboard')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button onclick="navigate('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button onclick="navigate('lessons')">üìö –£—Ä–æ–∫–∏</button>
        </div>
        <div id="content-area">
            </div>
    </div>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–Ω–∞—à–∏ "—Å—Ç—Ä–∞–Ω–∏—Ü—ã")
        function navigate(page) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
           
            // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç —Å–ª–æ–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç fetch-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±—ç–∫–µ–Ω–¥
            if (page === 'dashboard') {
                contentArea.innerHTML = '<h2>–°–≤–æ–¥–∫–∞</h2><p>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: 50% –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤.</p><p>–ù–∞–∂–º–∏—Ç–µ "–£—Ä–æ–∫–∏", —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>';
            } else if (page === 'profile') {
                contentArea.innerHTML = '<h2>–ü—Ä–æ—Ñ–∏–ª—å</h2><p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å –±—ç–∫–µ–Ω–¥–∞ –ø–æ JWT-—Ç–æ–∫–µ–Ω—É.</p><p>–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ LocalStorage.</p>';
            } else if (page === 'lessons') {
                contentArea.innerHTML = '<h2>–£—Ä–æ–∫–∏</h2><ul><li>–£—Ä–æ–∫ 1: –§—Ä—É–∫—Ç—ã</li><li>–£—Ä–æ–∫ 2: –ñ–∏–≤–æ—Ç–Ω—ã–µ</li></ul>';
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å —ç–∫—Ä–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showApp(userName) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('welcome-message').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
            navigate('dashboard'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status-message');
            const idElement = document.getElementById('telegram-id');
            const token = localStorage.getItem('jwt_token');
            // --- –®–ê–ì 0: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é ---
            if (token && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const userName = window.Telegram.WebApp.initDataUnsafe.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                showApp(userName);
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞
            }
            // !!! –í–°–¢–ê–í–¨–¢–ï –ê–î–†–ï–° NGROK –î–õ–Ø –í–ê–®–ï–ì–û –ë–≠–ö–ï–ù–î–ê (–ø–æ—Ä—Ç 8080) !!!
          const backendUrl = 'https://definable-outspokenly-janyce.ngrok-free.dev/api/auth/telegram';
            // -----------------------------------------------------------------
            // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---
            if (window.Telegram.WebApp && window.Telegram.WebApp.initData) {
               
                const unsafeData = window.Telegram.WebApp.initDataUnsafe;
                const user = unsafeData.user;
                if (user && unsafeData.auth_date && unsafeData.hash) {
                   
                    idElement.textContent = user.id;
                    statusElement.textContent = `–î–∞–Ω–Ω—ã–µ ${user.first_name} –ø–æ–ª—É—á–µ–Ω—ã. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥...`;
                   
                    // –®–õ–ò RAW INITDATA (—Å—Ç—Ä–æ–∫—É –∏–∑ WebApp)
                    const initData = window.Telegram.WebApp.initData;  // –≠—Ç–æ "auth_date=...&user={\"id\":...}&hash=..."
                    console.log('DEBUG: Raw initData –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:', initData);  // –î–ª—è –¥–µ–±–∞–≥–∞ ‚Äî –æ—Ç–∫—Ä–æ–π F12 > Console

                    fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: initData })  // { "initData": "raw_string" }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error('–ë—ç–∫–µ–Ω–¥ –æ—Ç–∫–∞–∑–∞–ª: ' + response.status + ' | ' + text.substring(0, 100))
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // –£–°–ü–ï–•! –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω
                        localStorage.setItem('jwt_token', data.token); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                       
                        statusElement.classList.add('success');
                        statusElement.textContent = '‚úÖ –£—Å–ø–µ—Ö! JWT-—Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω.';
                       
                        showApp(user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                        window.Telegram.WebApp.showAlert('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                    })
                    .catch(error => {
                        statusElement.classList.add('error');
                        statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ngrok –∑–∞–ø—É—â–µ–Ω.`;
                        console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    });
                } else {
                    statusElement.classList.add('error');
                    statusElement.textContent = '‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram.';
                }
               
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            } else {
                statusElement.classList.add('error');
                statusElement.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ Telegram.';
            }
        });
    </script>
</body>
</html>
  
