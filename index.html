<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
   
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í–µ—Å—å CSS –≤—Å—Ç—Ä–æ–µ–Ω, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f0f4f7);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #0088cc);
            --tg-hint: var(--tg-theme-hint-color, #888888);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            padding: 20px;
        }
        .container {
            background-color: var(--tg-secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        h1 {
            color: var(--tg-link);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
        }
        .error {
            background-color: #ffe0e0;
            color: #cc0000;
        }
        .success {
            background-color: #e0ffe0;
            color: #008000;
        }
        .loading {
            background-color: #e0f0ff;
            color: #0066cc;
        }
        #nav-bar button {
            background-color: var(--tg-link);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        #content-area {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--tg-bg);
            border-radius: 8px;
            text-align: left;
        }
        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8em;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .retry-button {
            background-color: var(--tg-link);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="container">
            <h1>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h1>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –í–∞—à–∞ –ª–∏—á–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è...</p>
            <div class="status loading" id="status-message">‚è≥ –ò–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <p style="font-size: 0.8em; opacity: 0.7;">ID: <span id="telegram-id">--</span></p>
            
            <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
            <div class="debug-info" id="debug-info" style="display: none;">
                <strong>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                <div id="debug-content"></div>
            </div>
            
            <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; font-size: 0.8em;">
                –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É
            </button>
            
            <button class="retry-button" onclick="retryAuth()" id="retry-button" style="display: none;">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>
    </div>
    <div id="main-app" class="container" style="display: none;">
        <h1 id="welcome-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
       
        <div id="nav-bar">
            <button onclick="navigate('dashboard')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button onclick="navigate('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button onclick="navigate('lessons')">üìö –£—Ä–æ–∫–∏</button>
        </div>
        <div id="content-area">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let debugInfo = '';
        
        // !!! –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–í–û–ô URL –ë–≠–ö–ï–ù–î–ê –ó–î–ï–°–¨ !!!
        const backendUrl = 'https://definable-outspokenly-janyce.ngrok-free.dev/api/auth/telegram';
        // -----------------------------------------------------------------

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        function navigate(page) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
           
            if (page === 'dashboard') {
                contentArea.innerHTML = '<h2>–°–≤–æ–¥–∫–∞</h2><p>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: 50% –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤.</p><p>–ù–∞–∂–º–∏—Ç–µ "–£—Ä–æ–∫–∏", —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>';
            } else if (page === 'profile') {
                const token = localStorage.getItem('jwt_token');
                contentArea.innerHTML = `<h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                    <p>–¢–æ–∫–µ–Ω: ${token ? token.substring(0, 20) + '...' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}</p>
                    <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</p>`;
            } else if (page === 'lessons') {
                contentArea.innerHTML = '<h2>–£—Ä–æ–∫–∏</h2><ul><li>–£—Ä–æ–∫ 1: –§—Ä—É–∫—Ç—ã</li><li>–£—Ä–æ–∫ 2: –ñ–∏–≤–æ—Ç–Ω—ã–µ</li></ul>';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showApp(userName) {
            console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è:', userName);
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('welcome-message').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}!`;
            navigate('dashboard');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ initData
        function cleanInitData(initData) {
            const params = initData.split('&');
            const allowedParams = params.filter(param => {
                const key = param.split('=')[0];
                return ['auth_date', 'query_id', 'user', 'hash', 'receiver', 'chat', 'chat_type', 'chat_instance', 'start_param'].includes(key);
            });
            
            const cleanedParams = allowedParams.filter(param => !param.startsWith('signature='));
            return cleanedParams.join('&');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function showDebugInfo(info) {
            const debugInfoElement = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugContent.textContent = info;
            debugInfoElement.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏
        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function retryAuth() {
            document.getElementById('retry-button').style.display = 'none';
            document.getElementById('status-message').className = 'status loading';
            document.getElementById('status-message').textContent = '‚è≥ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...';
            startAuthProcess();
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function startAuthProcess() {
            const statusElement = document.getElementById('status-message');
            const idElement = document.getElementById('telegram-id');
            
            debugInfo = 'üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n';
            debugInfo += `üåê Backend URL: ${backendUrl}\n`;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp
            if (!window.Telegram || !window.Telegram.WebApp) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
                debugInfo += '‚ùå Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            debugInfo += '‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
            const token = localStorage.getItem('jwt_token');
            if (token && window.Telegram.WebApp.initDataUnsafe?.user) {
                const userName = window.Telegram.WebApp.initDataUnsafe.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                debugInfo += '‚úÖ –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω\n';
                showDebugInfo(debugInfo);
                showApp(userName);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ initData
            if (!window.Telegram.WebApp.initData) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                debugInfo += '‚ùå initData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω\n';
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            const unsafeData = window.Telegram.WebApp.initDataUnsafe;
            const user = unsafeData?.user;

            if (!user || !unsafeData.auth_date || !unsafeData.hash) {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram';
                debugInfo += `‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: user=${!!user}, auth_date=${!!unsafeData.auth_date}, hash=${!!unsafeData.hash}\n`;
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
                return;
            }

            idElement.textContent = user.id;
            statusElement.textContent = `üîê –î–∞–Ω–Ω—ã–µ ${user.first_name} –ø–æ–ª—É—á–µ–Ω—ã. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥...`;

            debugInfo += `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name} (ID: ${user.id})\n`;
            debugInfo += `üì¶ –ò—Å—Ö–æ–¥–Ω—ã–π initData: ${window.Telegram.WebApp.initData.substring(0, 100)}...\n`;

            // –û—á–∏—â–∞–µ–º initData
            const cleanedInitData = cleanInitData(window.Telegram.WebApp.initData);
            debugInfo += `üßπ –û—á–∏—â–µ–Ω–Ω—ã–π initData: ${cleanedInitData.substring(0, 100)}...\n`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            showDebugInfo(debugInfo);

            console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥...');
            console.log('URL:', backendUrl);
            console.log('Cleaned initData:', cleanedInitData);

            try {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ initData: cleanedInitData }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('üì® –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç –±—ç–∫–µ–Ω–¥–∞:', data);

                if (!data.token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                localStorage.setItem('jwt_token', data.token);
                
                statusElement.className = 'status success';
                statusElement.textContent = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
                
                debugInfo += `‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${data.token.substring(0, 20)}...\n`;
                showDebugInfo(debugInfo);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                setTimeout(() => {
                    showApp(user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                }, 1000);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                
                statusElement.className = 'status error';
                
                if (error.name === 'AbortError') {
                    statusElement.textContent = '‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç';
                    debugInfo += '‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (10 —Å–µ–∫—É–Ω–¥)\n';
                } else {
                    statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    debugInfo += `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}\n`;
                }
                
                showDebugInfo(debugInfo);
                document.getElementById('retry-button').style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
            startAuthProcess();
        });
    </script>
</body>
</html>
